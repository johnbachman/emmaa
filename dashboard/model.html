<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EMMAA dashboard</title>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>

  <!-- Latest compiled and minified CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

  <!-- Optional theme -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">

  <!-- Latest compiled and minified JavaScript -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

  <!-- AWS SDK -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.283.1.min.js"></script>  

  <script>
    // CONSTANTS AND IDs
    var EMMAA_STATE_COOKIE_NAME = 'emmaaStateCookie=';
    var EMMAA_ACCESSTOKEN_COOKIE_NAME = 'emmaaAccessCookie=';
    var EMMAA_IDTOKEN_COOKIE_NAME = 'emmaaIdCookie=';
    var EMMAA_STATE_COOKIE_NAME = 'emmaaStateCookie=';
    var EMMAA_ACCESSTOKEN_COOKIE_NAME = 'emmaaAccessCookie=';
    var EMMAA_IDTOKEN_COOKIE_NAME = 'emmaaIdCookie=';
    var STATE_VALUE = '' // State value to secure requests to cognito endpoints
    var ACCESS_TOKEN_STRING = ''; // access token string
    var ACCESS_TOKEN = {}; // access token
    var ID_TOKEN_STRING = ''; // id token string
    var ID_TOKEN = {}; // id token
    var REFRESH_TOKEN = ''; // refresh token (typically not provided without providing username/password directly)
    var APP_CLIENT_ID = '3ej6b95mbsu28e5nkcb6oa8fnp';
    var AUTH_ENDPOINT_BASE_URL = 'https://emmaa.auth.us-east-1.amazoncognito.com/oauth2/authorize?';
    var USER_SIGNED_IN = false;
    var identityId = '' // 
    var USER_POOL_ID = 'us-east-1_5sb1590b6'; // User pool ID; User info lives here
    var IDENTITY_POOL_ID = 'us-east-1:76854655-a365-4e69-b080-0f8ca94a46fc'; // IdentityPool Id for "emmaa s3 test pool"
    AWS.config.region = 'us-east-1' // Set region
    AWS.config.credentials = new AWS.CognitoIdentityCredentials({
        IdentityPoolId: IDENTITY_POOL_ID,
    });
    var EMMMAA_BUCKET = 'emmaa';

    // Initialize an S3 interface object
    // var s3Interface = new AWS.S3();

    // Check if user signed in immediately after page load
    $(document).ready(function(){
      console.log('document ready')
      var return_url = window.location.href;
      let url_dict = getDictFromUrl(return_url);

      // Get access and ID tokens
      // accessTokenString = _readCookie(EMMAA_ACCESSTOKEN_COOKIE_NAME)
      // idTokenString = _readCookie(EMMAA_IDTOKEN_COOKIE_NAME)

      // if (!accessTokenString | !idTokenString) {
      //   console.log('Could not read either idToken or accessToken!')
      //   notifyUser('Could not read either idToken or accessToken!')
      //   // Send user to be logged in again
      //   window.location.replace()
      // }

      // // Verify user
      // verifyUser(accessTokenString, idTokenString);

      // If linked from model name: load that model
      if (url_dict) {
        let model = url_dict['model']
        // Set the model to the one that is selected
        setModel(model)
        modelKey = 'models/' + model + '/' + model + '_model_meta.json';
        loadModelMetaData(EMMMAA_BUCKET, modelKey)
      }
    });

    function getTokenFromAuthEndpoint() {
      console.log('function getTokenFromAuthEndpoint()')
      STATE_VALUE = _getNewStateValue();
      // console.log('current STATE_VALUE: ' + STATE_VALUE)
      _writeCookie(EMMAA_STATE_COOKIE_NAME, STATE_VALUE, 1)
      base_url = AUTH_ENDPOINT_BASE_URL;
      resp_type = 'response_type=token';
      client_id='client_id=' + APP_CLIENT_ID;
      redirect = 'redirect_uri=http://localhost:5000/model.html';
      state = 'state=' + STATE_VALUE;
      cutom_scope = 'https://s3.console.aws.amazon.com/s3/buckets/emmaa/results.read'
      scope = 'scope=aws.cognito.signin.user.admin+openid+profile+' + cutom_scope;
      let get_url = base_url + resp_type + '&' + client_id + '&' + redirect + '&' + state + '&' + scope;
      console.log('get_url=' + get_url)
      window.location.replace(get_url) // Redirect
    }

    function _readCookie(cookieName) {
      console.log('function _readCookie()')
      var nameEQ = cookieName;
      var ca = document.cookie.split(';');
      for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
        if (c.indexOf(nameEQ) == 0) {
          console.log('function _readCookie() resolved cookie value ' + c.substring(nameEQ.length, c.length))
          return c.substring(nameEQ.length, c.length)
        };
      }
      console.log('function _readCookie() did not resolve cookie value')
      return;
    }

    function _writeCookie(cookieName, value, hours) {
      console.log('function _writeCookie(cookieName, value, hours)')
      if (hours) {
        let _hours = 0;
        maxHours = 12;
        if (hours > maxHours) {
          _hours = maxHours;
        } else {
          _hours = hours;
        } 
        // console.log('hours to expiration: ' + _hours)
        var date = new Date();
        date.setTime(date.getTime() + (_hours*60*60*1000))
        var expires = '; expires=' + date.toGMTString();
        // console.log('cookie expiration date: ' + date.toGMTString());
      } else var expires = '';  // No expiration or infinite?

      var cookieString = cookieName + value + expires + '; path=/'
      // console.log('cookieString: ' + cookieString);
      document.cookie = cookieString;
    }

    function _getNewStateValue() {
      let state = ''
      let numArray = window.crypto.getRandomValues(new Uint32Array(4))
      for (num of numArray) {
        state = state + window.btoa(num).replace(/=/g, '');
      }
      return state;
    }

    // VERIFY USER 
    function verifyUser(accessTokenString, idTokenString) {
      console.log('function verifyUser(accessTokenString, idTokenString)');
      cogIdServiceProvider.getUser({'AccessToken': accessTokenString}, function(err, data) {
        if (err) {
          console.log('Could not verify user');
          console.log(err, err.stack);
          notifyUser('Could not verify user');
          return false;
        } else {
          // console.log('User meta data from cogIdServiceProvider.getUser()');
          // console.log(data);
          username = data.Username;
          notifyUser('Hello ' + username + '!');
          ACCESS_TOKEN_STRING = accessTokenString;
          _writeCookie(EMMAA_ACCESSTOKEN_COOKIE_NAME, ACCESS_TOKEN_STRING, 1);
          ID_TOKEN_STRING = idTokenString;
          _writeCookie(EMMAA_IDTOKEN_COOKIE_NAME, ID_TOKEN_STRING, 1);
          USER_SIGNED_IN = true
          addUserToIdentityCredentials(ID_TOKEN_STRING) // Add user to identity pool 
          return true;
        }
      })
    }

    // ADD USER TO THE CREDENTIALS LOGIN MAP
    function addUserToIdentityCredentials(userIdToken) {
      console.log('Linking user to IdentityPool with ID userIdToken')
      AWS.config.credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: IDENTITY_POOL_ID,
          Logins: {
            // cognito-idp.<region>.amazonaws.com/<YOUR_USER_POOL_ID>
            'cognito-idp.us-east-1.amazonaws.com/us-east-1_5sb1590b6': userIdToken
          }
      });

      // Call to obtain credentials
      AWS.config.credentials.get(function(){

          // Credentials will be available when this function is called.
          var accessKeyId = AWS.config.credentials.accessKeyId;
          var secretAccessKey = AWS.config.credentials.secretAccessKey;
          var sessionToken = AWS.config.credentials.sessionToken;
      });

      // AWS.config.credentials.identityId should now be available
      console.log('Setting identityId for logged in user')
      identityId = AWS.config.credentials.identityId;
    }

    function grabJSON (url, callback) {
      return $.ajax({url: url, dataType: "json"});
    };

    // Can be used when something is public on S3
    function getPublicJson(bucket, key) {
      // For production: get list of results and select based on some criteria
      // base_url = 'https://s3.amazonaws.com';
      base_url = 'http://s3.amazonaws.com'; // Insecure url used for development on localhost
      pathString = '/' + bucket + '/' + key;
      url = base_url +  pathString.replace(/\/\//g, '/'); // Avoid double slashes;
      // console.log('getting json from ' + url);
      return grabJSON(url);
    }

    function getDictFromUrl(url) {
      // No url provided
      if (!url) return;
      var query = {};
      // Check if (authorization) code flow or token (implicit) flow
      if (url.split('#')[1]) {
        query = url.split('#')[1];
      } else if (url.split('?')[1]) {
        query = url.split('?')[1];
      } else return;
      
      var result = {};
      query.split("&").forEach(function(part) {
        var item = part.split("=");
        result[item[0]] = decodeURIComponent(item[1]);
      });
      return result;
    }
    
    function populateModelsList(s3Interface, model) {
      console.log('function populateModelsList(s3Interface, model)')
      let bucket = 'emmaa';
      let prefix = 'models';
      let endsWith = 'model_meta.json'
      return listObjectsInBucket(s3Interface, bucket, prefix, model, 100, endsWith);
    }

    function listObjectsInBucket(s3Interface, bucket, prefix, model, maxKeys, endsWith) {
      console.log('function listObjectsInBucket(s3Interface, bucket, prefix, model, maxKeys, endsWith)');
      let _maxKeys = 1000
      if (maxKeys) {
        _maxKeys = maxKeys;
      }
      let params = {
        Bucket: bucket,
        MaxKeys: _maxKeys,
        Prefix: prefix
      }
      s3Interface.listObjectsV2(params, function(err, data) {
        if (err) console.log(err, err.stack);
        else {
          // console.log('List of objects resolved from S3')
          // console.log(data)
          let ddSelect = document.getElementById('modelSelectDD');
          tableBody.innerHTML = null;
          var modelKey = '';
          for (let i = 0; i < data.Contents.length; i++) {
            if (endsWith & data.Contents[i].Key.endsWith(endsWith)) {
              let option = document.createElement('option');
              option.value = data.Contents[i].Key;
              option.textContent = data.Contents[i].Key.split('/')[1];

              // Store model Key
              if (model & model.toLowerCase() == data.Contents[i].Key.split('/')[1].toLowerCase()) {
                modelKey = data.Contents[i].Key;
              }

              ddSelect.appendChild(option);
            }
          }

          if (model) {
            // select the model option if it exists
            for (child of ddSelect.children) {
              if (child.textContent.toLowerCase() == model.toLowerCase()) {
                // Change this option to selected
                child.selected = 'selected';
                break
              }
            }
            // Load model json
            loadModelMetaData(bucket, modelKey);
          }
        }
      });
    };

    function loadModelMetaData(bucket, modelKey) {
      console.log('function loadModelMetaData(bucket, modelKey)')
      modelMetaInfoPromise = getPublicJson(bucket, modelKey)
      modelMetaInfoPromise.then(function(json) {
        listModelMetaData(json);
      });
    }

    function listModelMetaData(json) {
      var metaTableBody = document.getElementById('modelMetaDataTableBody');
      metaTableBody.innerHTML = null;
      // Put json info in table or similar structure
      for (var k in json) {
        let tableRow = document.createElement('tr');

        keyColumn = document.createElement('td');
        keyColumn.textContent = k
        valueColumn = document.createElement('td');
        valueColumn.textContent = json[k]

        tableRow.appendChild(keyColumn);
        tableRow.appendChild(valueColumn);

        metaTableBody.appendChild(tableRow);
      }
    }

    function setModel(model) {
      // Sets the selected option
      let ddSelect = document.getElementById('modelSelectDD');
      for (child of ddSelect.children) {
        if (model == child.value) {
          child.selected = 'selected';
          break;
        }
      }      
    }

    function selectModel() {
      // Get selected option
      ddSelect = document.getElementById('modelSelectDD');
      var model = '';
      for (child of ddSelect.children) {
        if (child.selected) {
          model = child.value;
          break;
        }
      }
      modelKey = 'models/' + model + '/' + model + '_model_meta.json';
      loadModelMetaData(EMMMAA_BUCKET, modelKey);
    }

    // CHANGE TEXT
    function notifyUser(outputText) {
      let outputDiv = document.getElementById('status-notify');
      outputDiv.textContent = outputText;
    }

  </script>
</head>

<body>
  <div class="page-header">
    <h1 class="display-3">EMMAA models</h1>
    <p id="status-notify"></p>
    <hr>
  </div>

  <div class="container">
    <div class="input-group">
      <select class="custom-select" id="modelSelectDD" aria-label="Example select with button addon">
        <option selected disabled hidden>Select model...</option>
        <option value="aml">Acute myeloid leukemia (AML)</option>
        <option value="brca">Breast cancer (BRCA)</option>
        <option value="luad">Lung adenocarcinoma (LUAD)</option>
        <option value="paad">Pancreas adenocarcinoma (PAAD)</option>
        <option value="prad">Prostate adenocarcinoma (PRAD)</option>
        <option value="skcm">Skin cutaneous melanoma (SKCM)</option>
      </select>
      <div class="input-group-append">
        <button class="btn btn-outline-secondary" onClick="selectModel()" type="button">Load Model</button>
      </div>
    </div>
  </div>

  <div class="container" id="modelMetaDataTable">
    <table class="table">
      <thead>
        <th>Key</th>
        <th>Value</th>
      </thead>
      <tbody id="modelMetaDataTableBody"></tbody>
    </table>
  </div>

  <div class="container" id="modelTestsTable">
    <table class="table">
      <thead>
        <th>Test ID</th>
        <th>Passed</th>
        <th>Details</th>
      </thead>
      <tbody id="modelTestsTableBody"></tbody>
    </table>
  </div>

</body>
</html>
